# Created by Eugene M. Izhikevich, February 25, 2003
# Translated to Python by Enrico Migliorini
import numpy as np
import matplotlib.pyplot as plt
import progressbar

Ne = 800
Ni = 200
sampleNeuron = 76 #Taking one

# Now it's deterministic, I can log everything that goes on.
#stable100 = np.array([ 0.67268635, 0.96309749, 0.55220653, 0.89180605, 0.23468753, 0.81446299, 0.02195218, 0.83865616, 0.32659993, 0.24142225, 0.25734255, 0.91201752, 0.76794863, 0.23790365, 0.98089552, 0.92428144, 0.21600643, 0.83424292, 0.69386298, 0.46489522, 0.014518, 0.01957745, 0.7461725, 0.46113239, 0.61514745, 0.92841833, 0.08349969, 0.95070375, 0.58733038, 0.19839871, 0.25190411, 0.56569044, 0.6211112, 0.92418393, 0.72089119, 0.36120168, 0.25103747, 0.77158686, 0.71478856, 0.89871678, 0.90135932, 0.7473526, 0.22538937, 0.51225528, 0.56152225, 0.93567016, 0.63801067, 0.95226071, 0.73292152, 0.18399366, 0.1024284, 0.99834277, 0.56280422, 0.01583075, 0.06538782, 0.4483554, 0.99148011, 0.01410149, 0.81852111, 0.8343277, 0.93690884, 0.99741748, 0.29923517, 0.79460516, 0.51615389, 0.14538083, 0.04862664, 0.62384621, 0.59551652, 0.9189782, 0.89446678, 0.49094778, 0.18917208, 0.3231677, 0.34190464, 0.7116547, 0.49402238, 0.2225873, 0.15917861, 0.73371542, 0.69298251, 0.57648452, 0.64508938, 0.42175717, 0.62483895, 0.36801571, 0.76858529, 0.31535117, 0.009977 , 0.46877673, 0.94155195, 0.20507172, 0.52609205, 0.36366941, 0.76585519, 0.94148786, 0.42066063, 0.06366899, 0.43467719, 0.05397984])
stable1000 = np.array([0.815605958151, 0.890833593787, 0.199097033205, 0.408612149146, 0.364370284126, 0.492814189937, 0.803684798079, 0.71170071691, 0.668754253458, 0.30331039414, 0.303018605824, 0.414806001207, 0.72351249385, 0.805577780954, 0.21198717363, 0.669705570854, 0.950192987061, 0.487512334197, 0.889447292691, 0.285249152572, 0.00234765290586, 0.374245393685, 0.284894017859, 0.838520035124, 0.796332744775, 0.22570082218, 0.46649642854, 0.126667696559, 0.640486988133, 0.630363812355, 0.0572538857826, 0.260072935234, 0.647999769397, 0.259754889216, 0.470081606182, 0.249541745573, 0.912913274789, 0.511457791166, 0.170193712783, 0.922004905654, 0.165026043633, 0.158043033532, 0.264583679889, 0.53368238791, 0.40205618662, 0.86391468371, 0.439414415321, 0.385024148393, 0.373842863189, 0.606458193503, 0.439204120349, 0.283564461906, 0.810331113558, 0.0406989447235, 0.706828488468, 0.0391790934342, 0.178456110257, 0.993058443049, 0.656942207594, 0.693388832172, 0.436791188258, 0.16810832855, 0.834679897316, 0.920599509821, 0.285175126661, 0.62861122191, 0.528655286969, 0.8358685012, 0.582207668406, 0.402742195714, 0.0625455283594, 0.186111831378, 0.654344082399, 0.900636753095, 0.70300721874, 0.062088471089, 0.294710520829, 0.987409889345, 0.508260621875, 0.622543246633, 0.713842023417, 0.450037935647, 0.616452765031, 0.744641319832, 0.732961410767, 0.928416906524, 0.487305852188, 0.537798133786, 0.929984749379, 0.756303380692, 0.761599466498, 0.823886476302, 0.0457162151571, 0.472272608329, 0.461441498088, 0.950315838399, 0.799465244025, 0.0954441229208, 0.582848091906, 0.00495012139053, 0.0563721304701, 0.405503421483, 0.257393953324, 0.540406464745, 0.128452309803, 0.516808135534, 0.290571841371, 0.68616900372, 0.351057734614, 0.572826007638, 0.0461529754122, 0.325347121048, 0.908015222539, 0.417780078215, 0.792874501903, 0.470682519851, 0.774294074029, 0.193846437751, 0.896824934943, 0.880114405326, 0.931575359394, 0.477691110141, 0.0787590696384, 0.287981749454, 0.891395382061, 0.477313643923, 0.737770495646, 0.975148811106, 0.0349353818261, 0.0429022404018, 0.267415826567, 0.322560357243, 0.287505765103, 0.818002238204, 0.688666275643, 0.49838788938, 0.433622072919, 0.0754945964402, 0.390012531236, 0.711453743591, 0.489987446044, 0.113915188157, 0.987641899512, 0.124423997903, 0.665784205631, 0.555303168743, 0.0355642451113, 0.72245219574, 0.293429693778, 0.134614407802, 0.52012133055, 0.0142754695022, 0.959707310391, 0.166798727955, 0.00907848939509, 0.911845534732, 0.844567716931, 0.395140992768, 0.885214364165, 0.298384657744, 0.465214081024, 0.600094527679, 0.373485375407, 0.24779595314, 0.350998799691, 0.207310971477, 0.584715337868, 0.386169340287, 0.896410415874, 0.325364603563, 0.0875086880752, 0.607307151221, 0.440384432456, 0.242264045812, 0.157640049651, 0.982747636263, 0.437186293205, 0.459580578553, 0.260674865112, 0.887245768537, 0.675421011203, 0.383795739754, 0.128197222866, 0.707907832627, 0.0475448662438, 0.0655797934391, 0.909993534219, 0.115668025814, 0.220873324677, 0.167486965934, 0.00867900447504, 0.335722253036, 0.839266228742, 0.455250798656, 0.1296564338, 0.530641832905, 0.987841517803, 0.19568646299, 0.435244048763, 0.750341827308, 0.701129368471, 0.100999758038, 0.107452523712, 0.281039989528, 0.888056730167, 0.615906091615, 0.522158943391, 0.520490835102, 0.981290054739, 0.627162244282, 0.198504294414, 0.923312599867, 0.671672520648, 0.939525443991, 0.341448190602, 0.0785489813428, 0.57623894184, 0.747827539989, 0.728616279225, 0.169153392822, 0.273655723723, 0.319185613555, 0.858176644665, 0.327953070679, 0.348414791012, 0.611637758276, 0.853316501613, 0.0909902553702, 0.515539907797, 0.963645360975, 0.268057117514, 0.71254218745, 0.280659419319, 0.474262016519, 0.575577551415, 0.284379760735, 0.61706875373, 0.553598056728, 0.955817336565, 0.759331620712, 0.279170475048, 0.863232452208, 0.346664741969, 0.740530621839, 0.413534177669, 0.796103096202, 0.724475918429, 0.307828737101, 0.730729587887, 0.882586875137, 0.97602536824, 0.931687739941, 0.759833027846, 0.561309662006, 0.64206766125, 0.538563022757, 0.212714418143, 0.0776513133157, 0.870136986487, 0.998087816424, 0.931157013885, 0.614010424648, 0.756294947297, 0.459385517636, 0.588410522646, 0.764844588234, 0.0276204118866, 0.416525803742, 0.631563368812, 0.952226248865, 0.565811935105, 0.805949772554, 0.597948326896, 0.840660870619, 0.477293715143, 0.872512087039, 0.758470053933, 0.254305803793, 0.0535094848443, 0.495669173226, 0.405024911653, 0.751168131222, 0.841749656842, 0.447348648039, 0.338198998263, 0.242706572857, 0.495676834327, 0.726063234967, 0.405721397692, 0.584303830716, 0.00470714040637, 0.410516809451, 0.809650332543, 0.681955972316, 0.274713455334, 0.366346000642, 0.198313874354, 0.709080046508, 0.81664033112, 0.17013905723, 0.807507830117, 0.595194759884, 0.441570066943, 0.0902547179671, 0.584147287948, 0.929545361878, 0.930775786775, 0.743447645928, 0.696420733496, 0.239941573711, 0.163307694024, 0.429486194922, 0.656673845714, 0.236031004599, 0.185781480466, 0.310489058323, 0.965171131948, 0.546705624854, 0.0552135824593, 0.0524761113973, 0.452497454482, 0.0174332304081, 0.394954372553, 0.0695921259186, 0.823311652433, 0.660206991015, 0.678466906186, 0.679612890133, 0.358620266675, 0.334849516238, 0.264521036482, 0.583391497163, 0.699025085844, 0.866832809998, 0.764038285211, 0.88472337224, 0.434184596043, 0.305796303208, 0.896234981014, 0.66342271483, 0.634219655109, 0.702938388025, 0.541351225525, 0.145823601996, 0.615121370051, 0.438866278645, 0.785237416128, 0.207830004821, 0.554995766968, 0.832289999877, 0.739566220036, 0.233324151186, 0.098040495161, 0.579651907998, 0.107841434775, 0.441073753555, 0.909571411907, 0.335115506986, 0.0775038368957, 0.0126884697272, 0.329779590734, 0.433047246671, 0.94287735744, 0.011154416461, 0.571978388463, 0.808974590722, 0.0172019849763, 0.256462884192, 0.911134725883, 0.597331525087, 0.223885978196, 0.195369694417, 0.0607663322914, 0.532635044182, 0.174292869688, 0.201694026333, 0.64547076083, 0.0628395515493, 0.609217673792, 0.247963477597, 0.374452682035, 0.336075222481, 0.748115384396, 0.184347404442, 0.78784712702, 0.295241997177, 0.446072113019, 0.420100432621, 0.46979384407, 0.663603231756, 0.723864427943, 0.691285420178, 0.673650357126, 0.56344558169, 0.305520461708, 0.0052388071989, 0.0835120971422, 0.253376267292, 0.77710147672, 0.72525491039, 0.859803272245, 0.137056310483, 0.306075890826, 0.536523420261, 0.0398727461776, 0.233029445315, 0.825929780997, 0.61393657347, 0.559712686111, 0.395739429977, 0.532429558092, 0.209717441179, 0.897617183532, 0.96538698082, 0.630174556264, 0.072117115456, 0.38933579719, 0.530498800721, 0.97330277737, 0.441224462588, 0.02467648623, 0.441524960011, 0.631067723811, 0.394172690856, 0.725946212002, 0.0232423435384, 0.938859016285, 0.232873762931, 0.545182433231, 0.703288286799, 0.716895941297, 0.872522659695, 0.689103637203, 0.450736264497, 0.743334780621, 0.203204039555, 0.72549848229, 0.0185267695388, 0.538607820739, 0.577113373561, 0.78211781289, 0.305987900113, 0.847604216205, 0.27506817324, 0.849972092852, 0.406698239551, 0.399580818677, 0.65944566948, 0.851505037488, 0.126791287512, 0.718768930968, 0.579090245596, 0.788808680994, 0.790083423713, 0.622644882911, 0.529281803806, 0.703964621436, 0.000569892960783, 0.29792090086, 0.902554858954, 0.98664843492, 0.773050978077, 0.763464285881, 0.919088351334, 0.94394578509, 0.926008526443, 0.450198604354, 0.699546302703, 0.217317031325, 0.79007999068, 0.70627467596, 0.474428814623, 0.145175762968, 0.631598953669, 0.709620348358, 0.304807751865, 0.991965109366, 0.64838363553, 0.357486574604, 0.52469214293, 0.106392630577, 0.950775337191, 0.0795540913648, 0.719387397786, 0.269446146565, 0.292530908555, 0.884374447979, 0.192152980983, 0.120366302807, 0.2334759011, 0.956108318319, 0.579548398676, 0.34200212226, 0.897341850505, 0.785424855376, 0.942194239809, 0.249789259753, 0.835676020428, 0.387676372327, 0.382294927161, 0.0679992531836, 0.743796724417, 0.624359093689, 0.211439740509, 0.430023855591, 0.714232504412, 0.754473886054, 0.374651703466, 0.680299102839, 0.276541153478, 0.349946593202, 0.434651619232, 0.398106675294, 0.759700333408, 0.147154507842, 0.155003653935, 0.77203010822, 0.169269842682, 0.645913810491, 0.350128164773, 0.373941492496, 0.323176681679, 0.264352299427, 0.0760041563922, 0.522593454257, 0.375075127414, 0.616083997012, 0.501743937113, 0.0936825714527, 0.686058161497, 0.222430155028, 0.0460666165384, 0.907618803112, 0.9054609611, 0.85578201649, 0.539199615252, 0.188658475534, 0.438705905782, 0.214879878147, 0.643761350673, 0.390758708801, 0.244896979501, 0.0423639377056, 0.445241865846, 0.948917385124, 0.0576236631836, 0.574747682089, 0.0275102615135, 0.810729019923, 0.433971522057, 0.747122533543, 0.112140023369, 0.689559489582, 0.962207608381, 0.801024257447, 0.0888957368096, 0.825756843758, 0.837369396536, 0.571263649396, 0.390346060795, 0.969530220603, 0.308995249303, 0.276976541536, 0.604887695991, 0.319168367034, 0.689970143936, 0.563820551817, 0.95343527972, 0.76797547389, 0.46039841772, 0.555628431132, 0.317497704588, 0.771967473829, 0.407286835252, 0.90626715889, 0.167790275068, 0.460249554449, 0.503079467937, 0.161929072839, 0.21800339567, 0.454932764937, 0.19517846789, 0.516278105684, 0.0385038223772, 0.144742393792, 0.549958323588, 0.303162841067, 0.615547435765, 0.39306288597, 0.460724672224, 0.780877122004, 0.356957549776, 0.0351642148583, 0.536780124229, 0.640084400043, 0.767374314799, 0.838330127376, 0.773581242366, 0.744266130852, 0.747930961597, 0.723487919581, 0.0562385551786, 0.769882961466, 0.590521017669, 0.904136932302, 0.784514555409, 0.328034869374, 0.394693380631, 0.430910993511, 0.370422654949, 0.133261943939, 0.256262860987, 0.780353368284, 0.24440343585, 0.440468448695, 0.704111641999, 0.154997113442, 0.171288725543, 0.512141142408, 0.210340986196, 0.747437882261, 0.892576071193, 0.830397821504, 0.759316949533, 0.483747695786, 0.251211487354, 0.880095271352, 0.772114367237, 0.852461752012, 0.438144336836, 0.677773808746, 0.00974031687118, 0.981659220799, 0.732594400163, 0.743924857572, 0.713380159383, 0.679565859739, 0.336503779251, 0.738583533542, 0.830543905903, 0.0722478525112, 0.648611426704, 0.718570428104, 0.936927997509, 0.470647580284, 0.887530391649, 0.306271395153, 0.762650601526, 0.40562014225, 0.863868223625, 0.456841741038, 0.753276565202, 0.943026955833, 0.699113323077, 0.304646789204, 0.5668528717, 0.608797805933, 0.938895700094, 0.593899483207, 0.280087915334, 0.936384554544, 0.837125635317, 0.869833012515, 0.268854784946, 0.557018242547, 0.313723077252, 0.314251343735, 0.000483999576527, 0.83645083064, 0.274401838486, 0.3712871442, 0.753548897747, 0.878428465809, 0.134728432169, 0.862118095583, 0.0486748975846, 0.443297447682, 0.94208553705, 0.292218925396, 0.931543199351, 0.950423595031, 0.744537149907, 0.459607737349, 0.475998879815, 0.494698369964, 0.880722543665, 0.21184744386, 0.36214888348, 0.230155695973, 0.0130991198783, 0.83282480261, 0.0315091325398, 0.640178082548, 0.268159054781, 0.203133406053, 0.0926747538468, 0.0507447232433, 0.0866890820483, 0.75848795918, 0.184378138943, 0.809903125082, 0.143714991435, 0.156182125863, 0.404240403761, 0.507359078026, 0.187024142701, 0.808902836657, 0.193172642115, 0.570235780057, 0.605370260362, 0.641369761688, 0.181937333975, 0.135128620163, 0.299162926489, 0.482653405936, 0.316632044431, 0.459208577186, 0.701988335334, 0.760763529159, 0.479458404366, 0.154678505986, 0.934438902376, 0.15737213344, 0.469236450457, 0.425944565225, 0.361429403204, 0.015561411784, 0.604686830212, 0.935139761139, 0.312689817831, 0.0278096497615, 0.349905902386, 0.77916823963, 0.893647384475, 0.461351233858, 0.702357062438, 0.963866972878, 0.854970343814, 0.688626975316, 0.258430800274, 0.709495927661, 0.491930560588, 0.350765624356, 0.175415148916, 0.837182008736, 0.776617875091, 0.737000177077, 0.399314076641, 0.510773235241, 0.979169109923, 0.0246173102591, 0.465511221981, 0.227434150659, 0.11355651357, 0.265600777724, 0.718861334973, 0.652262369392, 0.915613146635, 0.42076200605, 0.18412712033, 0.0069668759017, 0.373100515738, 0.393088324532, 0.827066515441, 0.579746950524, 0.787700618513, 0.394617718018, 0.343592057495, 0.561915391125, 0.331595470419, 0.152519081784, 0.373414897683, 0.0894757321416, 0.831223833983, 0.530314088185, 0.12050753865, 0.625308231857, 0.683686822175, 0.693743451243, 0.272063630306, 0.575371225906, 0.721137270569, 0.319002747411, 0.726597551557, 0.0598031173991, 0.157772455968, 0.53735304235, 0.637798227985, 0.265423901191, 0.0424208056509, 0.251830898164, 0.723498796194, 0.147579635992, 0.566298857361, 0.391367429694, 0.633828630504, 0.030360625732, 0.60888914237, 0.771384856911, 0.679007015291, 0.725380279199, 0.854143803999, 0.534901015746, 0.30058635612, 0.759247663136, 0.168946647627, 0.631599171081, 0.673019028991, 0.363843551035, 0.120178009933, 0.402479942348, 0.693312481441, 0.133856046537, 0.680992432627, 0.228764068911, 0.874518753804, 0.503950120205, 0.0425718670442, 0.558687869172, 0.216977402455, 0.726846316956, 0.651017243204, 0.503669102419, 0.830704369101, 0.701380963212, 0.393815456711, 0.882415397458, 0.165630529934, 0.0676904465724, 0.829564343125, 0.51711028216, 0.967468014019, 0.605599802599, 0.861598931833, 0.450602135373, 0.191830853183, 0.677285599302, 0.514912659234, 0.465211213673, 0.0781984325139, 0.320751415723, 0.733006842097, 0.99866547688, 0.754567906632, 0.579302986097, 0.65164124733, 0.231601736101, 0.0015606497395, 0.0756143735203, 0.256769461536, 0.523586499171, 0.283613597026, 0.590116173735, 0.0772642679461, 0.987501084266, 0.934032064962, 0.361437614922, 0.112947739649, 0.1178936797, 0.0450958047383, 0.579555433261, 0.651268455062, 0.749339805558, 0.206090779229, 0.943008798665, 0.0934403111376, 0.763264147616, 0.217004354185, 0.513812432369, 0.130570050889, 0.274510311822, 0.34982847929, 0.587106720387, 0.124835928557, 0.459692767192, 0.599121450704, 0.418647448323, 0.164846933554, 0.403263417903, 0.0358162066726, 0.369263712951, 0.352399231709, 0.523005245831, 0.668520650192, 0.815381240275, 0.087303555805, 0.265275352867, 0.279534875474, 0.829814122706, 0.110948262845, 0.46683320855, 0.261609522922, 0.0715057077705, 0.00038985185505, 0.766478625208, 0.675544196479, 0.553313726293, 0.477791776561, 0.695514118671, 0.875005733805, 0.742193974946, 0.0492607205632, 0.480020883801, 0.689661657647, 0.369496786505, 0.873174234967, 0.362356630498, 0.666345956395, 0.873583995308, 0.807201440411, 0.294975952526, 0.138235025301, 0.55812035527, 0.38563138379, 0.496654232424, 0.585304951033, 0.143265899771, 0.4336560972, 0.391289074206, 0.225817301232, 0.138547733404, 0.79420830714, 0.724009899396, 0.684380039973, 0.106040698944, 0.43215599486, 0.0486305460292, 0.559459659789, 0.436732947998, 0.837145268625, 0.320388291313, 0.0711212703735, 0.545216009937, 0.711352406653, 0.600017949782, 0.647641115702, 0.461799972946, 0.109705729623, 0.196414796814, 0.297199358511, 0.0899444401495, 0.498712794377, 0.870089226862, 0.21614940191, 0.301328505472, 0.796405855434, 0.182478082459, 0.404230419194, 0.45795605727, 0.611598432671, 0.722391100102, 0.724620184527, 0.412335629463, 0.578442007706, 0.0696446095694, 0.844555359445, 0.443005632864, 0.472856213714, 0.157779567461, 0.726505130358, 0.228859911376, 0.243006398615, 0.485391573824, 0.849459750799, 0.0179902986874, 0.612171070847, 0.12362196918, 0.884451916674, 0.0020602899471, 0.158387445292, 0.978374240794, 0.55141933251, 0.621210031883, 0.925632639387, 0.815007765903, 0.441092134229, 0.0922505875152, 0.956119457009, 0.187029071948, 0.539235097669, 0.0685710276177, 0.470260081485, 0.425011271248, 0.484020435217, 0.239256618092, 0.691370200658, 0.528214098133, 0.467033853257, 0.781762722434, 0.960945743037, 0.0518095559915, 0.974801577771, 0.735912979423, 0.482091852097, 0.520231846831, 0.363599301119, 0.989150613672, 0.857171961963, 0.914198264776, 0.384594269151])
re = stable1000[:Ne]
ri = stable1000[Ne:]

#re = np.random.rand(Ne)
#ri = np.random.rand(Ni)
a = np.append(np.ones((Ne))*0.02, 0.02+0.08*ri)
b = np.append(np.ones((Ne))*0.2, 0.25-0.05*ri)
c = np.append(-65+15*np.power(re, 2), -65*np.ones(Ni)) #-65mV for RS neurons
d = np.append(8-6*np.power(re, 2), 2*np.ones(Ni)) #As above
S = np.hstack((0.5*np.ones((Ne+Ni, Ne))*0.6, -1*np.ones((Ne+Ni, Ni))*0.6)) #derandomized. Multiplied by 0.6 as it's close to the average
#S = np.hstack((0.5*np.random.rand(Ne+Ni, Ne), -1*np.random.rand(Ne+Ni, Ni)))

v = -65*np.ones(Ne+Ni)
u = np.multiply(b, v)
firings = []
sampleVTracer = []
sampleUTracer = []

print("Stats[96]: ", a[96], b[96], c[96], d[96], v[96], u[96])

timelimit = 1000
with progressbar.ProgressBar(maxval=timelimit) as progress:
  for t in range(timelimit):
    I = np.append(re*5, ri*2) #Derandomized again. Becomes much more regular.
    fired = np.asarray([n>=30 for n in v])
    sampleVTracer.append(v[sampleNeuron])
    sampleUTracer.append(u[sampleNeuron])
    #Plotting via comprehension list because that's how I roll
    firings.append([1 if n else 0 for n in fired])
    v[fired] = c[fired]
    u[fired] = u[fired]+d[fired]
    #print(v[sampleNeuron], u[sampleNeuron])
    #print(I.shape)
    #print(S.shape)
    I = I+np.sum(S[:,fired], axis=1)
    v=v+0.5*(0.04*np.power(v,2)+5*v+140-u+I)
    v=v+0.5*(0.04*np.power(v,2)+5*v+140-u+I) #For numerical stability
    u=u+np.multiply(a,(np.multiply(b,v)-u))
    '''print("Step ", t)
    print("deltaV[96]: ", 0.04*np.power(v[96],2))
    print("deltaV[96]: ", 0.04*np.power(v[96],2)+5*v[96])
    print("deltaV[96]: ", 0.04*np.power(v[96],2)+5*v[96]+140)
    print("deltaV[96]: ", 0.04*np.power(v[96],2)+5*v[96]+140-u[96])
    print("deltaV[96]: ", 0.04*np.power(v[96],2)+5*v[96]+140-u[96]+I[96])
    print("Stats[96]: ", I[96], a[96], b[96], c[96], d[96], v[96], u[96])'''
    progress.update(t)
 
firings = np.asarray(firings)
plt.matshow(firings, cmap='Greys')
plt.show()
#plt.plot(range(timelimit), sampleVTracer, 'b', range(timelimit), sampleUTracer, 'r', range(timelimit), [30 for tl in range(timelimit)], "g")
#plt.show()
